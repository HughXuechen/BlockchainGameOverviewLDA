Blockchain-enabled Carbon and Energy Trading for Network-Constrained Coal Mines with Uncertainties
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 1
Blockchain-enabled Carbon and Energy Trading for
Network-Constrained Coal Mines with Uncertainties
Hongxu Huang, Zhengmao Li, Member, IEEE, L. P. Mohasha Isuru Sampath, Jiawei Yang, Student
Member, IEEE, Hung D. Nguyen, Hoay Beng Gooi, Fellow, IEEE, Rui Liang, Dunwei Gong
Abstract—In this paper, a blockchain-enabled distributed mar-
ket framework is proposed for the bi-level carbon and energy
trading between coal mine integrated energy systems (CMIESs)
and a virtual power plant (VPP) with network constraints. To
maximize the profits of these two entities and describe their
complicated interactions in the market, the bi-level trading prob-
lem is formulated as a Stackelberg game considering integrating
the energy market and the “cap-and-trade” carbon market
mechanism. Meanwhile, in the CMIES, energy recovery units
and belt conveyors can be flexibly scheduled and the pumped
hydroelectric storage in the VPP is scheduled for energy manage-
ment. To tackle uncertainties from PV outputs, the joint trading,
and the energy management is solved by the distributionally
robust optimization (DRO) method. In addition, for participants’
privacy, the alternating direction method of multipliers (ADMM)
- based DRO algorithm is applied to solve the trading problem in
a distributed framework. Further, the Proof-of-Authority (PoA)
blockchain is deployed to develop a safe and anonymous market
platform. Finally, case studies along with numerous comparison
cases are conducted to verify the effectiveness of the proposed
method. Simulation results indicate that the proposed method can
effectively reduce the system operation cost and regional carbon
emission, reduce the conservativeness and protect the privacy of
each participant.
Index Terms—Joint carbon and energy market, blockchain,
distributionally robust optimization, ADMM
NOMENCLATURE
A. Acronyms
ADMM Alternating direction method of multipliers
BC Belt conveyor
DSO Distribution system operators
PHS Pumped hydroelectric storage
TOU Time-of-use tariff
VPP Virtual power plant
CMIES Coal mine integrated energy system
B. Indexes and Sets
A(n) Set of ancestor buses
C(n) Set of descendant buses
N/n Set/Index of buses in distribution grid
NI Set of CMIES
H/t Set/Indice of the operation time slots
C. Parameters
rn/xn Resistance and reactance of the branch between
the bus A(n) and n
αi/βi Emission function parameters of CMIES i
ηd/ηm Effciency parameter of the BC
λS,t
Grid/λ
B,t
Grid Feed in/Purchase TOU tariff
VBC Belt speed of the BC
τS,tVPP/τ
B,t
VPP Sale/Purchase carbon emission right price of
CMIES i from VPP
θ1/θ2/θ3/θ4 Design parameter of the BC
ai/bi/ci Cost function parameters of CMIES i
Tce Carbon tax price
D. Variables
pn/qn Active and reactive power injections of bus n
Pm/Qm Active/reactive power between bus n and m ∈
C(n)
Pn/Qn Active/reactive power between bus A(n) and
n
un Voltage of bus n
κS,t
VPP/κ
B,t
VPP Sale/Purchase power price of CMIES i from
VPP
ceS,tVPP/ce
B,t
VPP Sale/Purchase carbon emission right of CMIES
i from VPP
hi,t
TSTC/h
i,t
TSTD Charging/Discharging thermal power of the
TST in CMIES i at time t
pi,tCHP/p
i,t
MT CHP/MT power output of CMIES i at time t
pi,tBC/q
i,t
BC Power/Feed rate of the BC in CMIES i at time
t
ptPHSC/p
t
PHSD Charging/Discharging power of the PHS at
time t
CE i Carbon emission of CMIES i
CGi Generation cost of CMIES i
Ei,t+1
TST SOC of the TST in CMIES i at time t
Ei,t
Silo,k SOC of the kth Silo in CMIES i at time t
Et
PHS SOC of the PHS at time t
cei,tL Carbon emission of CMIES i at time t
I. INTRODUCTION
THE coal mine industry is undergoing irreversible de-
carbonization with the clean energy supply and recovery.
In coal mines, many energy resources such as ventilation air
methane [1], coal seam gas [2] and gusing water [3] are
recovered by means of power generation and exhaust heat
recovery, which has enormous potential in the coal mine
decarbonization.
Under this circumstance, the coordinated operation schedul-
ing of CMIESs emerges to facilitate the synergies between
electricity and thermal energy for economic benefits. In [4],
CMIESs are equipped with various energy recovery units and
deal with uncertainties by dispatching CMIESs under a two-
stage robust stochastic optimization framework. To gain more
profits, Ref. [5] considers the BCs and coal silos for demand
response to save energy supply costs based on the time-of-use
(TOU) tariff. Apart from the economic cost, multiple conflict-
ing objectives of CMIESs are optimized with an piecewise
NSGA II-based algorithm [6].
Meanwhile, as coal production gradually gets saturated in
some coal seams, abandoned resources can be utilized for
clean energy supply. Abandoned surface land resources are
utilized for photovoltaic (PV) farms. Besides, PHS [7], a
promising storage technology is also developed using the
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 2
abandoned goaf to charge and discharge at different times.
Hence, by integrating PV generation with PHS dispatching
management, a VPP can enhance the flexibility of renewable
energy supply [8], [9].
Although in [4]–[6], the coordinated operational scheduling
of CMIESs is studied, they are confined to a fixed TOU
tariff. In fact, the total annual power demand of the coal
mining process in China was 90.628 billion kWh in 2018
[10]. With such a huge demand, neglecting their dynamic
pricing in an decentralized energy market will restrict the
practicality and impair the welfares of coal mine enterprises.
Meanwhile, in coal mines, the VPP and CMIESs are two kinds
of entities connected to the same physical network. Typically,
they have complex market roles depending on their power
surplus or shortage. Nonetheless, previous studies have not
reached how to balance their diverse and conflicting interests
in a decentralized marketplace.
Given this insight, it is vital to design a suitable energy
trading model with the leader–follower structure between the
VPP and CMIESs for maximizing their own profits. Modelling
their energy trading as a bi-level optimization problem [11],
[12] is an effective approach to maximize their own benefits.
In the marketplace, the VPP can take the leader position to
give the price first and CMIESs follow the price to decide
their commodity by the independent optimal scheduling. To
deal with energy trading problems, cooperative [13]–[15] and
non-cooperative game theories [16], [17] are widely studied.
In these approaches, the Stackelberg game is well suited to
describe the interaction between two parties with conflicting
interests and/or a win-win optimal solution. In the literature,
Ref. [18] addressed energy as a Stackelberg game with a
bidding mechanism. The microgrid operator acts as the leader
and all participating prosumers are considered as followers.
Ref. [19] seeks to model the interaction between the retailer
and consumers, and it is modeled as a one-leader-N-follower
Stackelberg game. In [20], the coordination of demand re-
sponse and internal prices in energy trading is considered
in the Stackelberg game to present the consumers’ behavior.
Besides, the cost and utility models for prosumer benefits
are established by modeling the energy trading between pro-
sumers as a Stackelberg game. To further consider the trading
strategies, in [21], the arbitrage strategy is enforced in the
Stackelberg game where the equilibrium can both reduce the
energy supply and carbon emission cost.
Although in [17]–[21], the energy trading is optimized
to the game equilibrium, these studies only modelled the
carbon emission as the penalty cost. Joint carbon and energy
trading market has not been considered in these studies to
obtain the Stackelberg equilibrium. According to the Kyoto
Protocol, carbon trading markets [22] have been set in many
countries and regions as the “cap-and-trade” market to reduce
greenhouse gas emissions. Since the main carbon emission in
energy system comes from fossil generation, how to integrate
the carbon trading and energy trading as a joint marketplace
is still a remaining issue.
Moreover, in the carbon and energy markets, the mas-
sive key private information, including energy price, power
exchange quantity and units carbon emission parameters,
should be protected to guarantee trading fairness. One effective
privacy-preserving way is to solve the problem in a decentral-
ized manner [23] as all the private information will be only
kept within each party. In this regard, the ADMM, which deals
with trading problems locally with a finite number of iterations
and the guarantee of convergence, is appropriate [24]. In
[25], the interaction between prosumers is addressed with
the ADMM with their information updated in a decentralized
manner. Ref. [26] deploys the ADMM method for the energy
trading considering the voltage management in the distribution
grid. However, these approaches are based on a third-party
operator to manage the network, and can not preserve nodal in-
formation privacy. To the best of our knowledge, decentralized
network operation and privacy preserved carbon and energy
trading is still unaddressed in the literature.
Blockchain technology, as one of the promising distributed
ledger technologies, has been studied for establishing a trans-
parent and secure energy trading marketplace. Ref. [27] de-
signs the consortium blockchain technology for a P2P elec-
tricity trading market among plug-in electric vehicles, which
enables the aggregators to participate in a ensure privacy
preserved and trustworthy P2P trading. Ref. [28] designs a
hierarchical blockchain mechanism for the distributed control
system operation and double auction mechanism-based energy
trading. Ref. [29] establishes a neighboring energy market-
place for P2P energy trading, while a noise-based differential
privacy algorithm is utilized to change the feature of transac-
tion records without affecting the accuracy of records.
Nevertheless, these blockchain implementations are con-
fined to auction-based trading mechanisms. Game theory,
including the cooperative game, non-cooperative game and
the Stackelberg game, can effectively capture complicated
participants’ interactions and strategies and achieve the game
equilibrium. The cooperative game is applied to the multi
microgrids to describe their energy trading behaviors under
the blockchain base trading framework [30]. In [31], a non-
cooperative game theory-based pricing model is proposed
in a localized Practical Byzantine Fault Tolerance based-
Consortium Blockchain (PBFT-CB) for the decentralized en-
ergy trading. The energy trading under the Stackelberg game
framework in [32] is also processed by the credit-based
blockchain to reduce the calculation cost and promote the
exergy trading efficiency. However, these approaches execute
the energy market clearing in a centralized manner, which
cause the loss of data privacy and the efficiency of energy
trading.
The distributed nature of blockchain framework enables the
energy trading to be optimized by the distributed algorithm,
which enhances the information privacy and computation
efficiency. In [33], a decentralized energy trading algorithm
is proposed to improve the individual benefit and guarantee
the optimal performance of social welfare. The proposed
algorithm matches the blockchain system to avoid privacy
leakage in energy trading. To address the energy trading under
the blockchain framework, the energy market is designed in
[34] to be cleared by a decentralized Ant-Colony optimization
method. Intertemporal energy trading is executed through
smart contract implementation. Considering the dynamic net-
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 3
work operation and reconfiguration, the P2P energy trading is
addressed with a decentralized optimization model which can
adjust the network usage price to reach the balance between
P2P electricity trading maximization and distribution network
security [35]. However, to this end, the distribution network
operation is not fully validated in the smart contract, which is
vital for the practicality of energy trading.
From the research works above, it can be seen that though
the ADMM method is applied in some research works, little
attention has been paid to the privacy safety of the variable
update process. Hence, a promising technology with pseudo-
anonymous and immutability features called blockchain can
be coordinated with the ADMM approach for better con-
vergence performance and privacy-preserving. Nonetheless,
how to develop a blockchain-enabled trading marketplace
coordinating the distribution grid operation and energy trading
is an challenging task in both academia and industry.
Last but not least, though various researches have been
conducted on coal mines operation scheduling, the research
on the joint carbon and energy market, decentralized trading
under network operation and the blockchain-enabled privacy
preservation has not been touched for the coal mine industry.
To address the research gaps identified above, this paper
proposes a Stackelberg game-based joint carbon and energy
trading framework for the VPP and CMIESs with optimal
energy management. An ADMM-based DRO algorithm is pro-
posed for a decentralized market-clearing while dealing with
uncertainties from the renewables. Considering the privacy
preservation, the PoA blockchain is deployed with the smart
contract to protect key information and validate bus voltages.
The main contributions of this work are summarized as:
1) A Stackelberg game-based carbon and energy trading
marketplace is proposed for the VPP and CMIESs. From
the eco-friendly energy policy perspective, a carbon al-
location cap-based bi-level market is designed with non-
cooperative energy market for regional decarbonization.
2) To tackle the uncertainties from PV outputs and solve the
bi-level trading in a decentralized way, an ADMM-based
DRO algorithm is proposed. The proposed approach
effectively optimize the benefits of the VPP and CMIESs
by coordinating the local energy management and their
carbon and energy trading quantities.
3) A PoA blockchain is established to develop a safe
and anonymous transaction platform. Key information
updating, such as price and commodity, is encrypted
in the smart contract. Information privacy can be fully
guaranteed without sharing to a third-party.
II. BI-LEVEL TRADING FRAMEWORK UNDER NETWORK
MANAGEMENT
The physical network architecture and the bi-level energy
and carbon trading framework is presented in Fig. 1. Par-
ticipants in the carbon and energy trading market are the
VPP, the CMIESs, and the DSO. In the physical network,
participants are highlighted with different colors. In the radial
distribution grid, the ancestor node of VPP is connected to
the DSO and the child node is connected to all the CMIESs.
Each CMIES settles in different branches from the VPP. Their
Fig. 1. Bi-level energy and carbon trading framework.
power exchange are coordinated to the network operation
management in a decentralized manner.
1) VPP: With PV farms and the PHS system, the VPP can
behave as a prosumer to sell and purchase power depending
on its flexible energy management. Specifically, the power
generation of VPP does not emit carbon dioxide, which
enables the VPP to have excessive emission right to sell.
2) CMIES: Each CMIES is equipped with electrical and
thermal energy recovery units. Besides, their coal transporta-
tion systems can be flexibly scheduled as demand response
measures. With their energy management, the CMIESs are
prosumers in the market.
3) DSO: The DSO is the electricity retailer that purchases
or sells the electricity to the VPP and CMIESs when their
energy supply is excessive or insufficient. It should be noted
that the role of DSO is to keep the supply–demand balance in
the distribution network with the fixed TOU tariff. As such, the
DSO does not actively engage in the trading market. Energy
transactions between the DSO and other entities are settled
with a fixed TOU tariff.
A. Bi-level Carbon and Energy Trading Framework
1) Bi-level Trading Framework: Since the VPP and
CMIESs have conflicting interests, a Stackelberg game can
describe the bi-level decision process. In this study, the VPP
integrates uncertain renewable energy supply and energy stor-
age units, which can coordinate with all the CMIESs in the
network. Thus, the VPP is modelled as the leader in the
game that guides the energy transaction of CMIESs by using
reasonable prices. Then the CMIESs, as the followers, have
the liberty to decide the trading quantity or to trade with the
DSO by the TOU tariff.
2) Carbon and Energy Market: With PV farms, the VPP
can make a profit by selling excessive energy to the DSO
or the CMIESs. The CMIESs can also have flexible energy
transactions with either the VPP or the DSO based on their
market quota. Energy transactions between the DSO and the
VPP or the CMIESs are settled with a fixed TOU tariff.
Typically, the power price given by the VPP should be within
the range of the purchase and sale TOU tariffs given by the
DSO. In case of power unbalance, the VPP and the CMIES
will trade with the DSO, which brings fewer economic benefits
to the VPP and CMIESs.
Required by the “cap-and-trade” mechanism, all the market
participants are obligated to emit carbon dioxide within the
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 4
allocation and pay their own carbon emission tax. It is denoted
that the energy supplied by VPP can be regarded as having
no carbon emission. This empowers the VPP to gain trade
profits by selling carbon emission rights without carbon tax
cost. Thus, as mentioned in the bi-level framework, the VPP
will firstly decide the price of carbon emission right as a
leader. Then coal mine enterprises can purchase (sell) the
emissions right from (to) others depending on its emission
and its allocation cap.
Under the cap-and-trade mechanism, the VPP and CMIESs
are firstly allocated some free emission rights from an au-
thorized third party based on the grandfathering rule. The
surplus or shortage of allocated emission rights can be traded
by the participants as goods for economic benefits. It is
worth denoting that the initial emission rights are regarded as
parameters that can be adapted according to different cases.
Hence, the proposed trading model can effectively achieve the
game equilibrium without the loss of generality.
B. Distribution Network
To ensure that the energy transaction can be executed in
the distribution grid, we utilize the linearized Disflow network
model. In radial distribution grids A(1) = ∅. The input buses
of the CMIESs are denoted as n ∈ I(n) and the input bus of
the VPP is denoted as n ∈ J (n) , with I(n),J (n) ⊆ N . The
branch flow model for the distribution network is denoted as:
uA(n) = un + 2rnPn + 2xnQn (1a)
un ≤ un ≤ ūn (1b)
Pn =
∑
m∈C(n)
Pm − pn, Qn =
∑
m∈C(n)
Qm − qn (1c)
For all bus n ∈ N , Eq. (1a) constrains the voltage magnitude
and the power flow by the Ohm’s Law. Eq. (1b) denotes that
the voltage magnitude of each bus should be within the range
of maximal and minimal limits. Eq. (1c) enforces the active
and reactive power balance in the distribution grid. Thus,
the energy transaction should satisfy the distribution network
constraints (1a)-(1c).
III. SYSTEM MODELLING AND PROBLEM FORMULATION
A. Optimization Model of the CMIESs
To reduce the economic cost, the CMIESs are to optimize
their energy scheduling along with the energy and carbon
trading according to the VPP decision by the following model.
1) Objective Function : The objective function of each
CMIES i ∈ NI is formulated as:
Oi
CMIES =
∑
t∈H
(
CGi
(
pi,tCHP, p
i,t
MT
)
+Tcecei,tL
+COM
i (pi,tFL + hi,t
TSTC + hi,t
TSTD)
+ λB,t
Gridp
B,t
Grid,i − λS,t
Gridp
S,t
Grid,i
+ κB,t
VPP,ip
B,t
VPP,i − κS,t
VPP,ip
S,t
VPP,i
+ τBVPPce
B,t
VPP,i − τSVPPce
S,t
VPP,i
)
(2)
where H = {0, 1, 2, . . .}. CGi
(
pi,tCHP, p
i,t
MT
)
is the generation
cost function of the CHP and MT, which will be denoted
in (3). Tcecei,tL is the carbon emission tax for the local
carbon emission surplus cei,tL with the fixed tax price Tce.
The operation and maintenance units consists of the thermal
storage tank and flexible loads, such as WSHP, ASHP and
BCs, where the p. u. operation and maintenance cost is denoted
as COM
i with the flexible loads pi,tFL=pi,tWSHP+pi,tASHP+pi,tBC.
hi,t
TSTC and hi,t
TSTD are the thermal charging and discharging
power of the thermal storage tank (TST). The third line in
(2) denotes the energy trading between the DSO and the
CMIESs with TOU tariff λB,t
Grid and λS,t
Grid. Similarly, the
energy trading cost from the VPP is denoted in the fourth line
in (2) with the price κB,t
VPP,i and κS,t
VPP,i determined by the
VPP and the commodities pB,t
VPP,i and pS,tVPP,i. For the carbon
trading, ceB,t
VPP,i and ceS,tVPP,i are the emission rights purchase
(sale) from (to) the VPP respectively. τBVPP and τSVPP are the
respective prices.
2) Cost Function: In the objective function in (2), the
generation cost function of the CHP and the MT is given as
follows:
CGi
(
pi,tCHP, p
i,t
MT
)
=
∑
X∈{CHP,MT}
ai(p
i,t
X )2 + bip
i,t
X + ci (3)
where pi,tX represents for the power outputs of the CHP and
MT.
3) Carbon Emission Function: Also, the local carbon emis-
sion surplus cei,tL is determined by carbon emissions and
emission right transactions in each CMIES, denoted as:
cei,tL = CE i
(
pi,tCHP, p
i,t
MT
)
+ceS,tVPP,i−ce
B,t
VPP,i (4a)
CE i
(
pi,tCHP, p
i,t
MT
)
=
∑
X∈{CHP,MT}
αi
(
pi,tX
)2
+ βip
i,t
X (4b)
Eq. (4a) represents for the carbon emission surplus in the ith
CMIES at the tth hour. Eq. (4b) denotes the carbon emission
from CHP and MT power generation respectively.
4) Units Operation Constraints: Power outputs of the CHP
and MT are within the ramp up/down and thermal-electricity
conversion constraints [36] as:
riX ≤ (pi,t+1
X − pi,tX ) ≤ r̄iX ; ∀X ∈ {CHP, MT} (5a)
hi,t
X = pi,tX ηHER,i
X ; ∀X ∈ {CHP, MT} (5b)
hi,t
U = pi,tU ηCOP,i
U ; ∀U ∈ {WSHP, ASHP} (5c)
where riX and r̄iX are the ramp up/down limits of the CHP and
MT. pi,tU represents for the power consumption of the WSHP
and ASHP. hi,t
X and hi,t
U are the thermal outputs determined
by the heat electricity ratio (HER) ηHER,i
X and the coefficient
of performance (COP) ηCOP,i
U respectively.
TSTs are deployed in the CMIESs for flexible thermal
energy dispatching. The constraints of TSTs are given as:
Ei,t+1
TST = Ei,t
TST +
(
hi,t
TSTC−h
i,t
TSTD
)
∆t (6a)
Ei,0
TST = E
i,|H|
TST = Ei,init
TST (6b)
ETST ≤ Ei,t
TST ≤ ĒTST (6c)
hi
TSTC ≤ hi,t
TSTC ≤ h̄i
TSTC (6d)
hi
TSTD ≤ hi,t
TSTD ≤ h̄i
TSTD (6e)
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 5
Eq. (6a) denotes the characteristic of the thermal energy
storage Ei,t+1
TST with thermal energy charging and discharging.
The stored thermal energy at the beginning and end of a day
should be equal to the initial value, which is represented by
(6b). The min/max variables constraints are in (6c)-(6e).
In coal mines, the BCs are the main coal transportation
units to deliver raw coal from the work-face to the ground by
consuming electricity. The energy consumption of coal trans-
portation has a large proportion of the coal mine loads. Hence,
with coal storage in the silos, the BCs have the potential for
participating in demand response to reduce economic costs.
Based on many well-known standards or specifications, such
as ISO 5048, DIN 22101 and JISB 8805, a general BC energy
consumption model [37] was proposed as:
pi,tBC =
1
ηdηm
((
qi,tBC
)2(
VBCθ1 +
1
VBC
θ3
)
+qi,tBC
(
V2
BC
3.6
+ θ4
)
+VBCθ2
)
(7)
In this study, the optimal energy scheduling of the BCs
is focused on its coal delivey, which is mainly affected
by the feed rate. Coordinated with the coal silos, the coal
transportation system can be scheduled for demand response
under the coal delivery balance constraints. The virtual energy
storage constraints are given as:
mi,t
BC,k =
qi,tBC,k
3.6×VBC
, mi,t
BC,1 = mi,t
CF (8a)
Ei,t+1
Silo,k = Ei,t
Silo,k + (mi,t
BC,k −mi,t
BC,k+1)∆t (8b)
Ei,0
Silo,k = E
i,|H|
Silo,k = Ei,init
Silo,k (8c)
Ei
Silo,k ≤ Ei,t
Silo,k ≤ Ēi
Silo,k (8d)
Eq. (8a) represents the relationship between the coal delivery
mass mi,t
BC,k and feed rate qi,tBC,k of the kth level BC. Eq.
(8b) shows the coal storage in the kth level silo with kth
BC delivering coal into the silo and coal delivered out by
the k + 1th BC. Eq. (8c) ensures a sustainable transportation
scheduling in each day. Besides, the coal delivery demand are
also satisfied by delivering all the raw coal from the coal face
to ground, which is ensured by (8c). Eq. (8d) denotes that coal
storage of each silo should stay within its capacity limits.
Energy exchange and units operation variables are within
the maximal and minimal constraints as:
Θi,t ≤ Θi,t ≤ Θ̄i,t (9a)
where Θi,t = (pB,t
Grid,i, p
S,t
Grid,i, p
B,t
VPP,i, p
S,t
VPP,i, ce
B,t
VPP,i, ce
S,t
VPP,i,
pi,tCHP, p
i,t
MT, q
i,t
CHP, q
i,t
MT, p
i,t
WSHP, p
i,t
ASHP,m
i,t
BC,k) is limited
within the range between [Θi,t, Θ̄i,t].
5) Power and Thermal Energy Balances: For power bal-
ance in (1c), the active and reactive power injections pn∈I(n)
and qn∈I(n) of bus n ∈ I(n) are given as:
pn∈I(n) = pB,t
Grid,I(1)+ pB,t
VPP,I(1)− pS,tGrid,I(1)− pS,tVPP,I(1)
+ pn,tCHP + pn,tMT − pn,tFL − pn,tL (10a)
qn∈I(n) = qn,tCHP + qn,tMT − qn,tFL − qn,tL (10b)
where the energy transaction commodity is only calculated
at the intial bus I(1) of the ith CMIES. With (1c), the
power balance of each CMIES can be validated for energy
transactions in the distribution grid.
Thermal energy balance for each CMIES is ensured as:
hi,t
L = hi,t
CHP+hi,t
MT+hi,t
WSHP+hi,t
ASHP+hi,t
TSTD−h
i,t
TSTC (11)
B. Distributionally Robust Optimization Model of the VPP
As the leader in the Stackelberg game, the VPP is to make
the first move by determining the price for energy transactions
among the VPP and CMIESs. Uncertainties from the PV
output are addressed by the DRO method.
1) Objective Function: The VPP with surplus PV genera-
tion and energy storage is to make more profits by minimizing
the economic cost. In the day-ahead carbon and energy trading
market, the transaction and energy management cost of the
VPP can be formulated as:
OVPP =
∑
t∈H
(
COM
PHS(p
t
PHSC + ptPHSD) + Tce(ce
VPP,t
L )
+ λB,t
Gridp
B,t
Grid,VPP − λS,t
Gridp
S,t
Grid,VPP
+
∑
i∈NI
(
κS,t
VPP,ip
S,t
VPP,i − κB,t
VPP,ip
B,t
VPP,i
)
+
∑
i∈NI
(
τSVPPce
S,t
VPP,i − τBVPPce
B,t
VPP,i
))
(12)
The first part COM
PHS(p
t
PHSC + ptPHSD) in the objective
function (12) is the operation maintenance cost of the PHS.
Tce(ceL,tVPP) is the carbon emission tax cost for the local emis-
sion surplus ceL,tVPP.
(
λB,t
Grid
)T
pB,t
Grid,VPP −
(
λS,t
Grid
)T
pS,tGrid,VPP
denotes the cost of energy exchange between the VPP and
the DSO with fixed purchase and sale price λB,t
Grid and λS,t
Grid
respectively. For the energy exchange among the VPP and
all the CMIESs i ∈ NI , the cost of the VPP is denoted
as
∑
i∈NI
(
κS,t
VPP,i
)T
pS,tVPP,i−
(
κB,t
VPP,i
)T
pB,t
VPP,i where κB,t
VPP,i
and κS,t
VPP,i are the energy purchase and sale price for
CMIESs respectively. pB,t
VPP,i and pS,tVPP,i are the purchase
and sale commodities respectively, which are determined
by the CMIESs as the followers. For the carbon emission
right transaction, the corresponding cost is formulated as∑
i∈NI
(
τSVPP
)T
ceS,tVPP,i −
(
τBVPP
)T
ceB,t
VPP,i with fixed prices
τSVPP and τBVPP and emission right commodities ceS,tVPP,i and
ceB,t
VPP,i.
2) Pricing Criteria: For energy transactions, the clearing
price for the CMIESs and power commodity from the DSO are
within the maximal and minimal ranges denoted as follows:
λS,t
Grid ≤ κB,t
VPP,i ≤ λB,t
Grid, 0 ≤ pB,t
Grid,VPP ≤ p̄BGrid,VPP (13a)
λS,t
Grid ≤ κS,t
VPP,i ≤ λB,t
Grid, 0 ≤ pS,tGrid,VPP ≤ p̄SGrid,VPP (13b)
3) Energy Storage Unit: Apart from energy transactions,
the energy management of the energy storage unit is under
the constraints [4] as:
Et+1
PHS = Et
PHS +
(
ptPHSC − ptPHSD
)
∆t (14a)
E0
PHS = E
|H|
PHS = Einit
PHS (14b)
EPHS ≤ Et
PHS ≤ ĒPHS (14c)
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 6
p
PHSC
≤ ptPHSC ≤ p̄PHSC (14d)
p
PHSD
≤ ptPHSD ≤ p̄PHSD (14e)
4) Power Balance: For power balance in (1c), the active
and reactive power injections of bus n ∈ J (n) is given as:
pn∈J (n) = pB,t
Grid,J (1)+ pB,t
J (n),i− pS,tGrid,J (1)− pS,tJ (n),i
+ p̃n,tPV + pn,tPHSD − pn,tPHSC − pn,tL (15a)
qn∈J (n) = −qn,tL (15b)
where p̃n,tPV is the uncertain PV output.
5) Cap-and-trade Carbon Trading Mechanism : The car-
bon emission right trading is under the regional carbon emis-
sion allocation constraint as:
Ni∑
i
(
ceB,t
VPP,i − ceS,tVPP,i
)
= ceVPP,t
L (16a)
T∑
t
(
ceVPP,t
L +
NI∑
i
cei,tL
)
≤ c̄eCap (16b)
T∑
t
Ni∑
i
(
ceB,t
VPP,i − ceS,tVPP,i
)
= 0 (16c)
where NI is the number of CMIESs and c̄eCap is the regional
carbon emission limit pre-allocated by a concerned third party,
such as the cap-and-trade system in many countries. It is
worth noting that the carbon trading market framework can
be adapted to a peer centric trading framework among all the
CMIESs by ensuring the VPP’s carbon right trading surplus
is zero over all time intervals, which is denoted in Eq. (16c).
6) Uncertainty Modelling: In this study, we consider a
scenario based ambiguity set for modelling the uncertain PV
output in the DRO. First, we define that the random variable
ŵ = p̃n,tPV/p̂
n,t
PV as uncertain PV output over the forecasted
value. In the DRO framework, we consider the Wasserstein
metric [38] to constrain the uncertain variable w̃ centered
around the distribution P̂. The Wasserstein metric is denoted as
a tractable distance ρw : RIw×RIw by the following equation:
dW(P, P̂) inf
Q∈Q(P,P̂)
EQ[ρw(w̃, ŵ)]
=
(
inf
Q∈Q(P,P̂)
∫
RIw×RIw
ρw(w̃, ŵ)
2Q(dw̃, dŵ)
)1/2
(17)
where w̃ ∼ P, ŵ ∼ P̂ and Q(P, P̂) is the set of all joint
probability distributions on RIw × RIw with marginals P and
P̂. To ease the burden of computation, one natural approach to
describe the PV output based on different scenarios s ∈ S is
to use the uniform distribution P̂ on the discrete scenario set
S. Hence, P̂ = 1
S
∑
s∈[S] δw̃s
. Then the Wasserstein ambiguty
set is formulated by limiting the Wasserstein metric dW(P, P̂)
less than the radius θ. The radius θ of the Wasserstein metric
can be adjusted to adapt to the robustness requirement of the
uncertainties. Then, to formulate the Wassersteim ambiguity
set as a scenario-wise one, the auxiliary variable, ṽ, is intro-
duced for constraining the range of distance, ρw(w̃, ŵ). For
different scenarios s ∈ S, the primary random variable w̃ and
the auxiliary random variable ṽ jointly formulate the support
sets Zs = {(w̃, ṽ) | ρw(w̃, ŵ) ≤ ṽ, ŵ ∼ P̂} in the Fw(θ).
Then the Wasserstein ambiguity set is denoted as Eq.(18).
One tractable approach to solve the DRO problem with the
Wasserstein ambiguity set is known as linear decision rule
approach [39].
Fw(θ)=
P∈P0
((w̃, ṽ), s̃) ∈ P
EP[ṽ | s̃ ∈ [S]] ≤ θ
P [(w̃, ṽ) ∈ Zs|s̃ = s]=1, ∀s ∈ [S]
P[s̃ = s] = 1
s , ∀s ∈ [S]
(18)
C. Bi-Level Optimization Reformulation
We formulate the bi-level optimization problem of the VPP
and the CMIESs according to their the leader and follower
position in the Stackelberg game. We formulate the bi-level
optimization problem as follows.
1) Upper Level Problem Reformulation: To this end, the
upper level problem of the VPP is reformulated as:
min
x
sup
P∈Fw(θ)
EP OVPP +
ρ
2
∥x− x̂∥22 (19a)
s.t. (1),(13)-(16),(18) (19b)
where the objective is in the expected sense of total trad-
ing and operation cost with the uncertain PV output in
the Fw(θ). Decision variables in the VPP is denoted as
x =
[
κB,t
VPP,i, κ
S,t
VPP,i, ce
B,t
VPP,i, ce
S,t
VPP,i, p
B,t
Grid,VPP, p
S,t
Grid,VPP,
ptPHSC, p
t
PHSD
]
. The second part in the objective function is
the quadratic penalty terms that augment the optimal solution
towards the Stackelberg equilibrium. x̂ are the pre-solved
decision results in the last iteration and ρ is the step size
parameter used in the ADMM.
2) Lower Level Problem Reformulation: After the solution
of the upper level problem, the CMIESs is to optimize its
trading and the energy management problem is formulated as:
min
z
Oi
CMIES +
ρ
2
∥z− ẑ∥22 (20a)
s.t. (1),(3)-(11) (20b)
where the decision variables z of the CMIESs are denoted as
z =
[
pB,t
Grid,i, p
S,t
Grid,i, p
B,t
VPP,i, p
B,t
VPP,i, p
i,t
CHP, p
i,t
MT, p
i,t
WSHP, p
i,t
BC,
pi,tASHP, q
i,t
CHP, q
i,t
MT, q
i,t
WSHP, q
i,t
ASHP, q
i,t
BC, h
i,t
TSTC, h
i,t
TSTD
]
.
Similarly, ẑ are the decision results in the last iteration. ρ
is the step size parameter used for augmenting the optimal
solution with the quadratic penalty terms of z in the ADMM.
IV. STACKELBERG GAME-BASED MARKET
COORDINATION AND OPTIMIZATION ALGORITHM
A. Proof of Stackelberg Equilibrium
In this study, the transaction between the VPP and the
CMIESs is formulated as the one leader multiple followers
Stackelberg game. As the leader, the VPP announces the
energy price κ
B/S
VPP,i first. The CMIESs, as followers, follow
the price decision by announcing their willingness for energy
exchange. All the leader and followers are to minimize their
own cost respectively and reach the optimal strategies for all
the participants. This is the Stackelberg equilibrium.
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 7
Considering a game Ξ played by the VPP j and the CMIESs
i ∈ NI , this game is formulated as:
Ξ =
{
(j ∪NI), {κB/S
VPP,i}j , {p
B/S
VPP,i}i∈NI , O
VPP, {Oi}i∈NI
}
(21)
where {κB/S
VPP,i}j is the set of purchase and sale pricing
strategies of the VPP. {pB/S
VPP,i}i∈NI is the set of power
exchange strategies of the CMIESs. OVPP and {Oi}i∈NI
are the objective functions of the VPP and the CMIESs
respectively. Then, the Stackelberg equilibrium is defined as:
Definition 1. Considering the game Ξ in (21), a set of
strategies (κ⋆B/S
VPP,i, p
⋆B/S
VPP,i) attains the equilibrium if and only
if the following conditions are satisfied:
OVPP(κ⋆B/S
VPP,i, p
⋆B/S
VPP,i) ≤ OVPP(κ⋆B/S
VPP,i, p
B/S
VPP,i),
Oi(κ⋆B/S
VPP,i, p
⋆B/S
VPP,i) ≤ Oi(κ
B/S
VPP,i, p
⋆B/S
VPP,i); ∀i ∈ NI (22)
Once the equilibrium got attained, no other strategies can
bring more benefits for any participants in the game. Then we
can get Theorem 1 to prove the existence and uniqueness of
the Stackelberg equilibrium in the game Ξ.
Theorem 1. The Stackelberg equilibrium (κ⋆B/S
VPP,i, p
⋆B/S
VPP,i)
exists and is unique in the Stackelberg game Ξ.
Proof. The objective function in Eq. (19a) and Eq. (20a) are
continuous and differentiable. Then the Hessian matrices with
their own strategies (κB
VPP,i, κ
S
VPP,i) and (pBVPP,i, p
S
VPP,i) are:
HVPP/Hi =
[
ρ 0
0 ρ
]
(23)
Since ρ is a positive constant, the Hessian matrices are all
positive definite with their own strategies. This means that the
conditions of equilibrium are satisfied. We have the following
equation:
(κ⋆B/S
VPP,i, p
⋆B/S
VPP,i) = argmin(OVPP, {Oi}i∈NI ),
∀(κB/S
VPP,i, p
B/S
VPP,i) ∈ Ξ (24)
Hence, the Theorem 1 is proved.
B. Distributed Market Clearing Algorithm
Although the problem is strictly convex and can be solved
in a centralized manner, e.g., by the VPP, there are still
some drawbacks. Firstly, the CMIESs are not willing to
share their private information, such as the energy exchange
and carbon emission parameters in (4b); Also, a centralized
solving approach will burden the computational inefficiency
and latency, which is related to the number of scenarios in the
DRO. Besides, each participant only knows partial information
of the power flow variables in (1a)-(1c), (10a)-(10b) and (15a)-
(15b). Sharing their power flow information can be beneficial
to decentralized voltage management in the distribution grid.
To coordinate the VPP and the CMIESs in the bi-level
DRO problem in a decentralized way, one approach is to use
the decentralized feature of the ADMM algorithm. Since we
have proved the strictly convexity of the proposed problem
in Theorem 1, and the optimization problems (20) and (21)
consist of convex inequality and affine equality constraints.
This feature satisfies the Slater’s condition, which indicates
that the duality gap is zero in the proposed optimization
problem. Thus, the convergence condition of the ADMM-
based algorithms are satisfied and the detailed proof of the
convergence and global optimality is studied in [24]. To
validate the execution of the energy trading without violating
the distribution grid model in (1a)-(1c), we consider the node
voltage u and the residual rk [24] by the abstract power flow
constraints as:
uk+1 = uk +Axk +Bzk − c (25)
rk+1 =
∥∥xk− xk−1
∥∥2
2
+
∥∥zk− zk−1
∥∥2
2
+
∥∥uk− uk−1
∥∥2
2
(26)
where k is the iteration in the ADMM. Considering the DRO
problem, the pseudo-code distributed market coordination and
optimization algorithm is illustrated in Algorithm 1.
Algorithm 1: ADMM-based Market Clearing
Input : λB,t
Grid, λ
S,t
Grid, τ
B
VPP, Tce, τSVPP, p̂
n,t
PV,x
(0), z(0)
ρ, θ, ϵ, k = 1, r1 = +∞
1 while rk ≥ϵ do
2 Receive zk−1, Solve the DRO problem (19a).
3 Broadcast x(k) to the CMIESs: x-update
4 Receive xk, Solve the problem (20a).
5 Broadcast z(k) to the VPPs: z-update
6 Calculate the voltage residual (25).
7 Broadcast u(k) to all bus node: u-update.
8 k ← k + 1
9 end
Output: xk, zk, uk
C. Implementation of the PoA Blockchain
To provide a privacy-preserving environment for the ex-
ecution of the ADMM-based DRO algorihtm, we set up
the PoA private blockchain on the Ethereum platform. The
implementation of the PoA blockchain is shown in Fig. 2.
Fig. 2. The implementation of the PoA blockchain with ADMM update.
In the optimization layer, after the local decision of the VPP
and the CMIESs, the x-update, y-update and u-update process
data are sent to the User Datagram Protocol (UDP), which
will transfer the updated variables to the Ethereum client
Geth. We create a private blockchain network using the PoA
protocol in Geth. The smart contract which is designed for
variables update and voltage validation, is self-executed within
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 8
Algorithm 2: Smart contract with voltage validation
1 for each Block(bn) do
2 Require node.engage = true
3 Receive data from the UDP.
4 Receive data from the Block(bn−1).
5 Calculate the residual r(bn)
6 if r(bn) < ϵ then
7 if u(bn) ∈ [u, ū] then
8 Broadcast the transaction to Geth nodes;
9 else
10 Reject the transaction;
11 end
12 end
13 Broadcast x(bn), z(bn) and u(bn) to all nodes;
14 Return data via UDP;
15 end
the blockchain network. The data in the blocks generated are
encrypted by the Hash-function which is almost irreversible
to be decoded. In Block(bn), the information broadcast is
encrypted by the Hash-function and passed down to the next
Block(bn+1), which can be denoted as:
Block(bn+1) = Hash(x, z, u, t, Block(bn),SC) (27)
where bn is the sequence of the blocks and SC represents
the smart contract that is shown in Algorithm 2. Local op-
timization solutions are updated for all Geth nodes and be
broadcasted to the participants following the PoA protocol.
Thus, the variable update processes in the smart contract will
continue until the stopping criterion of Algorithm 1 is satisfied.
Then, the smart contract will validate the bus voltages to obtain
an executable transaction, which ensures the security of the
distribution grid.
The PoA blockchain is set up on the Ethereum platform.
Each blockchain node is assigned with a private key and
an address. The communication network is set up via the
bootnode tool which is a service of the private PoA blockchain,
which is more secure and efficient for decentralized energy
trading.
V. CASE STUDIES
The proposed bi-level energy and carbon trading with DRO
energy management is tested on the IEEE 33-bus test system
for the coal mine distribution grid to illustrate the effective-
ness. The system configuration of the test coal mines is the
same in Fig. 3. Fig. 4 represents the 50 uncertain scenarios of
the PV output. The carbon tax price Tce is set to $5.5/ton
and the purchase (sale) carbon emission right price is set
as $6.5 (4.5)/ton. The mathematical models are solved on a
MATLAB 2021b platform with the commercial solver Gurobi
9.1.2 [40]. The relative gap is set at 10−5. Parameters for
different energy units and loads are listed in Table I.
A. Energy trading and management results of the VPP
Fig. 5 represents the energy price with the comparison of
the TOU tariff and Fig. 6 shows the energy exchange between
the VPP and the CMIESs respectively.
Fig. 3. System configuration for case study.
Fig. 4. Uncertain PV output Scenarios.
TABLE I
TECHNICAL PARAMETERS OF ENERGY UNITS
Units
Rated
Power/
Capacity
Min/Max
Ramp
Power
Units
Rated
Power/
Capacity
Min/Max
Ramp
Power
PV 60 MW/- - WSHP 0.8 MW/- -0.2/0.2 MW
PHS 10 MW/80 MWh -8/8 MW ASHP 0.4 MW/- -0.2/0.2 MW
CHP 25&50 MW/- -8/8 MW TST 10 MW/40 MWh -4/4 MW
MT 25&50 MW/- -25/25 MW
Fig. 5. Comparison of the energy trading price and the TOU tariff.
Fig. 6. Energy exchange between the VPP and the CMIESs.
Fig. 5 shows that the energy price is within the range of the
purchase and sale TOU tariff. During the low-price time slots,
such as 4:00-7:00, the power purchase price for the CMIESs
is relatively high. Also, during high-price time slots, such as
15:00-18:00, the power purchase price is relatively lower than
the TOU tariff. They should be considered with the energy
exchange quantity results. Fig. 6 shows the energy exchange
quantity and power price. With demand side management, the
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 9
CMIESs are optimized to purchase power during 4:00-7:00 to
reduce power purchase costs. Also, the VPP gives a relatively
low energy purchase price when CMIESs determine to sell
energy to make profits during 15:00-18:00 and 24:00.
Fig. 7 illustrates the energy scheduling results of the VPP
in different slots. Based on the sampled scenarios, the PV
generation supplies power during 8:00 to 17:00. Thus, for a
better economic benefit, the excessive PV output is sold to
other participants. For the energy storage operation, the PHS
is mostly scheduled to store energy when the PV output is
sufficient during 9:00 to 16:00 while other times the PHS is
mostly scheduled to release energy to satisfy the load and sell
energy to the grid or the coal mines. Considering the energy
price in Fig. 5, the energy management of the PHS is utilized
flexibly for the economic welfare of the VPP. Constrained by
(14b), the SOC of the PHS at 24:00 is equal to the initial value
for a sustainable scheduling.
Fig. 7. The DRO energy scheduling results of the VPP.
B. Energy trading and management results of the CMIESs
With energy recovery units and coal transportation demand
response, the CMIESs can optimize its energy scheduling
to reduce economic cost. We take one of the CMIESs for
illustration. Fig. 8 shows the optimal power dispatching results
of the CMIES #1. Fig. 9 represents the energy exchange
between the CMIESs and the DSO.
Fig. 8. Optimal Power dispatching of the CMIES #1.
Fig. 9. Energy exchange between the CMIESs and the DSO.
From Fig. 8 and Fig. 9, the CHP and MT units are to gen-
erate power to satisfy the power demand. Considering carbon
emission tax and carbon transactions, the CHPs and MTs in
various CMIESs share different proportion of power supply
due to their various carbon emission parameters. Besides,
according to the energy price in Fig. 5, the insufficient power
shortage is supplied by purchasing power from the VPP or
the DSO during 4:00-7:00 while the excessive power output
is sold to the VPP or the DSO to make a profit. The flexible
loads, including the BCs and the heat pumps, shifted their
power demand to 4:00-7:00 by shaving the demand during
15:00-18:00 and 24:00.
As the dash lines shows, the coal silos are scheduled to store
and release the raw coal within the coal storage constraints,
which play the role of the VES. The stored raw coal in
different levels of silos increases at the beginning, which
means the BCs in the workface deliver the coal out for mining
safety while the upper level BCs deliver less coal for saving
energy cost. When the stored raw coal decreases, the BCs in
the shaft or on the ground deliver more coal out of the silos
to consume more power during low price periods.
Detailed coal transportation demand response are shown in
Fig. 10. The feed rate of the BC in the workface is stable
and equal to the raw coal production. The BCs in other level
are scheduled more flexibly as their feed rate can reach the
maximal delvery capacity and also go down to the minimal
limit. Hence, the BCs are scheduled to enhance the demand
response for a better economic benefits when considering
energy price and carbon tax.
Fig. 10. Coal transportation demand response in CMIES #1.
Thermal energy dispatching balance of the CMIESs are
shown in the Fig. 11. The main thermal power supply of
each CMIESs are the CHPs and MTs. They are scheduled to
supply thermal energy coordinated with electrical power. Thus
their thermal output is coordinated with the same operational
scheduling of their power dispatching respectively. Apart from
the energy recovery units, the WSHPs and the ASHPs supply
their maximal thermal power due to their lower maintenance
cost and no carbon emission caused by fossil fuel compared
with those of the CHPs and MTs. As flexible energy storage
units, the TSTs are scheduled to compensate the insufficient
thermal supply and store energy when the thermal output is
excessive.
C. Performance Evaluation
Firstly, we discuss the privacy preserving of the ADMM-
based DRO algorithm with the PoA blockchain. Fig. 12
shows the mining process of the PoA blockchain and Fig. 13
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 10
Fig. 11. Thermal energy dispatching result of the CMIES #1
represents the deployment of the smart contract in Algorithm
2. Before the convergence, the variable updating, including
the x-update, z-update and u-update in ADMM, are addressed
in the PoA blockchain. Fig. 14 shows the 2-norm residual
in the Algorithm 1 and 2. It can be observed that with the
variable update process in the blockchain, the residual is
reduced to 10−12 with 10 iterations. The reduced residual
reached the stopping criteria of the smart contract and satisfied
the converge conditions for the ADMM-based algorithm [24].
Hence, the private information is effectively preserved with
the coordination of the smart contract.
Fig. 15 shows the nodal voltage of the distribution network
at each time slot. The errors are measured by the per-unit value
by setting the voltage base values to 12.66 kV. The maximum
and the minimum voltages are 0.902 and 1.066, respectively.
The nodal voltage is acceptable in practice considering the
voltage limits are 0.9-1.1 p.u., which illustrates that the pro-
posed energy trading framework and market clearing algorithm
can effectively secure the operation of the distribution network.
Fig. 12. The mining process of the PoA blockchain.
Fig. 13. The deployment of the smart contract.
Fig. 14. Trace of the residual evaluated in the ADMM-based DRO algorithm.
To illustrate how the Stackelberg game will affect the
carbon trading, we make the comparison between the carbon
trading in the bi-level market and the peer-to-peer market.
The regional emission caps of both market are all set to
2240 ton. In the P2P market the VPP is not engaged in
Fig. 15. Nodal voltage of the distribution network.
the carbon emission trading while in the bi-level market they
can carry trades to sell the emission right to CMIESs at the
purchase price and pay the emission tax price. To validate the
effectiveness of the proposed method, three benchmarks are
compared:
Method # 1: Deterministic optimization method: The PV
output is regarded as deterministic forecasted data.
Method # 2: Two-stage RO method: The bi-level energy
and carbon trading with energy management is solved by the
two-stage RO method, the uncertainty degree is set to 0.2.
Method # 3: The DRO method: The bi-level problem is
solved by the DRO method with 50 scenarios of the PV output.
The Wasserstein distance radius is set to 0.2.
Table II shows that with the engagement of the VPP,
the carbon emission cap for each CMIES is lower. In both
markets, the CMIES#2 have emission right surplus as its
carbon emission is within the cap limit. Thus, the CMIES#2
can sell the emission right to other CMIESs whose local
emissions exceed their emission cap. Compared to the P2P
market, the CMIES#2 and #3 are to purchase more carbon
emission rights to ensure their own emission under the cap.
For the VPP, due to its clean energy generation from PV, the
VPP has no local carbon emission, which indicates that the
VPP can make use of its emission allowance to trade by selling
the emission right to others and paying the tax for making a
profit. From the perspective of local carbon emission, in the
bi-level market, the CMIESs are to schedule their own energy
units to reduce local carbon emission. Thus, the regional total
emission is reduced to 2142.16 ton. It can be concluded that
compared to the P2P carbon market, the bi-level carbon trading
contributes to 4.37% regional decarbonization.
The performance comparison results in Table III illustrates
that the different optimization approach for uncertain PV
output will not affect the energy trading cost of the CMIESs.
As the leader of the game, VPP will only decide its pricing
policy while the energy exchange quantity is decided by the
CMIESs. When the VPP is to maximize the power purchase
price for profits, it is equal for the CMIESs to choose purchase
power from the VPP or from the DSO. Thus, uncertainties
from the PV will not affect the energy transaction between
the VPP and the CMIES. However, the uncertain PV output
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 11
TABLE II
PERFORMANCE COMPARISON ON OPTIMIZATION METHODS
P2P carbon market Bi-level carbon market
Participants CMIES #1 CMIES #2 CMIES #3 VPP CMIES #1 CMIES #2 CMIES #3 VPP
Local Carbon Emission (ton) 839.75 620.29 779.97 - 837.76 545.64 758.77 0
Emission Right Trading (ton) 93.07 -126.38 33.30 - 277.76 -14.36 198.77 -462.16
Emission Cap (ton) 746.67 746.67 746.67 - 560.00 560.00 560.00 560.00
Regional Emission/Cap (ton) 2240/2240 2142.16/2240
TABLE III
COMPARISON BETWEEN BI-LEVEL CARBON MARKET AND P2P CARBON MARKET
Result Method #1 Method #2 Method #3
VPP CMIESs VPP CMIESs VPP CMIESs
Trading cost with DSO ($) -1082.88 -4453.46 7733.82 -4453.46 5114.02 -4453.46
Trading cost between the VPP and CMIESs ($) -24124.75 24124.75 -24124.75 24124.75 -24124.75 24124.75
Total cost ($) -25691.54 7569.73 -16874.76 7569.73 -19495.56 7569.73
Regional welfare ($) -18121.81 -9305.03 -11924.83
will affect the energy trading between the VPP and the DSO.
For Method #1, the VPP makes a profit of $1082.88 by selling
excessive PV generation to the DSO. This is due to the lack of
consideration of uncertainties. The deterministic case has no
robustness in optimization. Hence, for application, its optimal
solution cannot reflect the reality of uncertain PV output. For
Method #2, the trading cost between the VPP and the DSO
is $7733.82, which is conservative by finding the worst case
in the RO uncertainty set. Meanwhile, that trading cost with
DSO in Method #3 is $5114.02, which can overcome the
conservation of the RO method and reflect the uncertain PV
output in real cases. Correspondingly, the regional welfares,
the total cost of all the VPP and the CMIESs, will be affected
by the way to deal with PV output, which are -$18121.81,
-$9305.03 and -$11924.83. Hence, the solution with ADMM-
based DRO will provide a comparatively robust but also not
too optimistic energy trading cost.
VI. CONCLUSION
In this paper, a Stackelberg game based bi-level trading
framework with energy management is proposed to deal with
carbon and energy integrated energy trading in coal mines. The
uniqueness and existence of the Stackelberg game equilibrium
of the proposed model is proved. To deal with uncertainties
from the PV output, the energy management of the VPP is
solved by the DRO method using the Wasserstein ambiguity
set. Considering the security of private trading information,
the ADMM-based DRO algorithm is proposed to address the
trading problem in a distributed manner. Further, a Proof
of Authority (PoA) blockchain enabled market platform is
developed for a safe and anonymous transaction environment.
Numerical cases are simulated to validate the effectiveness
of the proposed method. Results indicate that the proposed bi-
level carbon and energy market can contribute towards regional
decarbonization. Also, the proposed ADMM-based DRO can
effectively protect private information by the PoA blockchain.
Compared with traditional methods, the proposed ADMM-
based DRO algorithm immune to various uncertainties from
the PV output and overcomes the conservatism of the robust
optimization method.
For future work, firstly the coordination between the day-
ahead market and the real-time market can be investigated un-
der the joint carbon and energy trading framework. Secondly,
considering ancillary services products, the price adjustment
mechanism can be introduced into the energy market.
REFERENCES
[1] I. Karakurt et al., “Mine ventilation air methane as a sustainable energy
source,” Renewable and Sustainable Energy Reviews, vol. 15, no. 2, pp.
1042–1049, 2011.
[2] Q. Zhang et al., “Coal mine gas separation of methane via clathrate
hydrate process aided by tetrahydrofuran and amino acids,” Applied
Energy, vol. 287, p. 116576, 2021.
[3] Al-Habaibeh et al., “Performance analysis of using mine water from an
abandoned coal mine for heating of buildings using an open loop based
single shaft gshp system,” Applied Energy, vol. 211, pp. 393–402, 2018.
[4] H. Huang et al., “Two-stage robust stochastic scheduling for energy
recovery in coal mine integrated energy system,” Applied Energy, vol.
290, p. 116759, 2021.
[5] Y. Mu et al., “Optimal scheduling method for belt conveyor system in
coal mine considering silo virtual energy storage,” Applied Energy, vol.
275, p. 115368, 2020.
[6] H. Hu et al., “Enhanced evolutionary multi-objective optimization-based
dispatch of coal mine integrated energy system with flexible load,”
Applied Energy, vol. 307, p. 118130, 2022.
[7] J. Fan et al., “Preliminary feasibility analysis of a hybrid pumped-
hydro energy storage system using abandoned coal mine goafs,” Applied
Energy, vol. 258, p. 114007, 2020.
[8] R. Gao et al., “Optimal dispatching of wind-pv-mine pumped storage
power station: A case study in lingxin coal mine in ningxia province,
china,” Energy, vol. 243, p. 123061, 2022.
[9] Z. Yi et al., “Bi-level programming for optimal operation of an active
distribution network with multiple virtual power plants,” IEEE Transac-
tions on Sustainable Energy, vol. 11, no. 4, pp. 2855–2869, 2020.
[10] National Bureau of Statics, Stastical year book of China. Beijing: China
statics Press, 2020.
[11] Y. Liu et al., “Gaussian process-based approach for bilevel optimization
in the power system – a critical load restoration case,” arXiv preprint
arXiv:2012.01388v2, 2022.
[12] P. Parikshit et al., “Optimal steady-state voltage control using gaussian
process learning,” IEEE Transactions on Industrial Informatics, vol. 17,
no. 10, pp. 7017–7027, 2020.
[13] L. P. M. I. Sampath et al., “Peer-to-peer energy trading enabled optimal
decentralized operation of smart distribution grids,” IEEE Transactions
on Smart Grid, vol. 13, no. 1, pp. 654–666, 2022.
[14] Azim et al., “Coalition graph game-based p2p energy trading with local
voltage management,” IEEE Transactions on Smart Grid, vol. 12, no. 5,
pp. 4389–4402, 2021.
[15] W. Zhong et al., “Cooperative p2p energy trading in active distribution
networks: An milp-based nash bargaining solution,” IEEE Transactions
on Smart Grid, vol. 12, no. 2, pp. 1264–1276, 2021.
[16] L. Wang et al., “Non-cooperative game-based multilateral contract
transactions in power-heating integrated systems,” Applied Energy, vol.
268, p. 114930, 2020.
[17] Mediwaththe et al., “Competitive energy trading framework for demand-
side management in neighborhood area networks,” IEEE Transactions
on Smart Grid, vol. 9, no. 5, pp. 4313–4322, 2018.
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply. 
JOURNAL OF LATEX CLASS FILES, VOL. 14, NO. 8, AUGUST 2021 12
[18] N. Liu et al., “Energy sharing management for microgrids with pv pro-
sumers: A stackelberg game approach,” IEEE Transactions on Industrial
Informatics, vol. 13, no. 3, pp. 1088–1098, 2017.
[19] L. He et al., “An occupancy-informed customized price design for
consumers: A stackelberg game approach,” IEEE Transactions on Smart
Grid, 2022.
[20] N. Liu et al., “Energy-sharing provider for pv prosumer clusters: A
hybrid approach using stochastic programming and stackelberg game,”
IEEE Transactions on Industrial Electronics, vol. 65, no. 8, pp. 6740–
6750, 2018.
[21] Nezamabadi et al., “Arbitrage strategy of renewable-based microgrids
via peer-to-peer energy-trading,” IEEE Transactions on Sustainable
Energy, vol. 12, no. 2, pp. 1372–1382, 2021.
[22] X. Zhou et al., “Partial carbon permits allocation of potential emission
trading scheme in australian electricity market,” IEEE Transactions on
Power Systems, vol. 25, no. 1, pp. 543–553, 2009.
[23] K. Zhang et al., “A framework for multi-regional real-time pricing in
distribution grids,” IEEE Transactions on Smart Grid, vol. 10, no. 6, pp.
6826–6838, 2019.
[24] S. Boyd et al., “Distributed optimization and statistical learning via the
alternating direction method of multipliers,” Foundations and Trends®
in Machine learning, vol. 3, no. 1, pp. 1–122, 2011.
[25] Haggi et al., “Multi-round double auction-enabled peer-to-peer energy
exchange in active distribution networks,” IEEE Transactions on Smart
Grid, vol. 12, no. 5, pp. 4403–4414, 2021.
[26] Ullah et al., “Peer-to-peer energy trading in transactive markets consid-
ering physical network constraints,” IEEE Transactions on Smart Grid,
vol. 12, no. 4, pp. 3390–3403, 2021.
[27] J. Kang, R. Yu, X. Huang, S. Maharjan, Y. Zhang, and E. Hossain,
“Enabling localized peer-to-peer electricity trading among plug-in hybrid
electric vehicles using consortium blockchains,” IEEE Transactions on
Industrial Informatics, vol. 13, no. 6, pp. 3154–3164, 2017.
[28] J. Yang, J. Dai, H. B. Gooi, H. D. Nguyen, and P. Wang, “Hierarchical
blockchain design for distributed control and energy trading within
microgrids,” IEEE Transactions on Smart Grid, vol. 13, no. 4, pp. 3133–
3144, 2022.
[29] K. Gai, Y. Wu, L. Zhu, M. Qiu, and M. Shen, “Privacy-preserving energy
trading using consortium blockchain in smart grid,” IEEE Transactions
on Industrial Informatics, vol. 15, no. 6, pp. 3548–3558, 2019.
[30] M. Yan, M. Shahidehpour, A. Alabdulwahab, A. Abusorrah, N. Gurung,
H. Zheng, O. Ogunnubi, A. Vukojevic, and E. A. Paaso, “Blockchain
for transacting energy and carbon allowance in networked microgrids,”
IEEE Transactions on Smart Grid, vol. 12, no. 6, pp. 4702–4714, 2021.
[31] Y. Jiang, K. Zhou, X. Lu, and S. Yang, “Electricity trading pricing
among prosumers with game theory-based model in energy blockchain
environment,” Applied Energy, vol. 271, p. 115239, 2020.
[32] N. Liu, L. Tan, L. Zhou, and Q. Chen, “Multi-party energy manage-
ment of energy hub: A hybrid approach with stackelberg game and
blockchain,” Journal of Modern Power Systems and Clean Energy,
vol. 8, no. 5, pp. 919–928, 2020.
[33] Q. Yang and H. Wang, “Blockchain-empowered socially optimal transac-
tive energy system: Framework and implementation,” IEEE Transactions
on Industrial Informatics, vol. 17, no. 5, pp. 3122–3132, 2021.
[34] A. Esmat, M. de Vos, Y. Ghiassi-Farrokhfal, P. Palensky, and D. Epema,
“A novel decentralized platform for peer-to-peer energy trading market
with blockchain technology,” Applied Energy, vol. 282, p. 116123, 2021.
[35] H. Ruan, H. Gao, H. Qiu, H. B. Gooi, and J. Liu, “Distributed operation
optimization of active distribution network with p2p electricity trading
in blockchain environment,” Applied Energy, vol. 331, p. 120405, 2023.
[36] Z. Li et al., “A risk-averse adaptively stochastic optimization method
for multi-energy ship operation under diverse uncertainties,” IEEE
Transactions on Power Systems, vol. 36, no. 3, pp. 2149–2161, 2021.
[37] S. Zhang et al., “Modeling and energy efficiency optimization of belt
conveyors,” Applied Energy, vol. 88, no. 9, pp. 3061–3071, 2011.
[38] R. Zhu, H. Wei, and X. Bai, “Wasserstein metric based distributionally
robust approximate framework for unit commitment,” IEEE Transactions
on Power Systems, vol. 34, no. 4, pp. 2991–3001, 2019.
[39] P. Xiong, P. Jirutitijaroen, and C. Singh, “A distributionally robust
optimization model for unit commitment considering uncertain wind
power generation,” IEEE Transactions on Power Systems, vol. 32, no. 1,
pp. 39–49, 2017.
[40] Gurobi Optimization, LLC, “Gurobi Optimizer Reference Manual,”
2021. [Online]. Available: https://www.gurobi.com
This article has been accepted for publication in IEEE Transactions on Sustainable Energy. This is the author's version which has not been fully edited and 
content may change prior to final publication. Citation information: DOI 10.1109/TSTE.2023.3240203
© 2023 IEEE. Personal use is permitted, but republication/redistribution requires IEEE permission.
See https://www.ieee.org/publications/rights/index.html for more information.
Authorized licensed use limited to: CITY UNIV OF HONG KONG. Downloaded on April 15,2023 at 09:17:07 UTC from IEEE Xplore.  Restrictions apply.